function Test-Feature {
    Write-Host "Check if DirectoryServices-DomainController is enabled..."
    $(dism /online /get-featureinfo /featurename:DirectoryServices-DomainController) -contains "State : Enabled"
}

Function Install-Domain {
    $script={
        Import-Module ADDSDeployment
        Install-ADDSForest -CreateDnsDelegation:${{cfg.CreateDnsDelegation}} `
                        -DatabasePath "{{cfg.DatabasePath}}" `
                        -DomainMode {{cfg.DomainMode}} `
                        -DomainName "{{cfg.DomainName}}" `
                        -DomainNetbiosName "{{cfg.DomainNetbiosName}}" `
                        -ForestMode {{cfg.ForestMode}} `
                        -InstallDns:${{cfg.InstallDns}} `
                        -LogPath "{{cfg.LogPath}}" `
                        -NoRebootOnCompletion:${{cfg.NoRebootOnCompletion}} `
                        -SafeModeAdministratorPassword $(ConvertTo-SecureString -String "{{cfg.SafeModeAdministratorPassword}}" -AsPlainText -Force) `
                        -SysvolPath "{{cfg.SysvolPath}}" `
                        -Force:${{cfg.Force}}
    }
    Start-Process powershell.exe -ArgumentList "-NonInteractive -Command $script" -Wait
}

if (!(Test-Feature)) {
    Write-Host "Enabling DirectoryServices-DomainController..."
    dism /online /enable-feature /featurename:DirectoryServices-DomainController /all
    dism /online /enable-feature /featurename:DirectoryServices-DomainController-Tools /all
    Install-Domain
    if (!(Test-Feature)) {
        Write-Host "DirectoryServices-DomainController was not enabled!"
        exit 1
    }
} else {
    # TODO: Add more logic to determine if the system was successfully promoted to a DC. If not, promote it.
}